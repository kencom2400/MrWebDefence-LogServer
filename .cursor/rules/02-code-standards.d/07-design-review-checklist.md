# 設計レビューチェックリスト

このドキュメントは、実装設計書のレビュー時に確認すべき観点をまとめたものです。

## 🎯 レビューの目的

- 実装前に設計の問題点を発見する
- システムの品質・パフォーマンス・保守性を担保する
- 実装時の手戻りを最小化する

---

## 📋 レビュー観点

### 1. アーキテクチャ設計

#### 1.1 システム構成
- [ ] コンポーネントの責務は明確か
- [ ] コンポーネント間の依存関係は適切か
- [ ] 単一障害点（SPOF）は存在しないか
- [ ] スケーラビリティは考慮されているか

#### 1.2 技術選定
- [ ] 選定技術は要件に適しているか
- [ ] 技術的な制約・リスクは明記されているか
- [ ] 代替案との比較検討がされているか

### 2. ネットワーク・通信

#### 2.1 コンテナ環境での通信
- [ ] `localhost`の使用は適切か（コンテナ間通信ではサービス名を使用）
- [ ] ホスト名やポート番号は設定ファイルから読み込めるか
- [ ] ネットワーク分離やファイアウォール設定は考慮されているか

#### 2.2 プロトコル選択
- [ ] HTTP/TCP/UDPの選択は要件に合っているか
- [ ] ストリームベースプロトコル（TCP）のメッセージフレーミングは適切か
- [ ] タイムアウト・リトライの設計はあるか

### 3. 非同期処理とパフォーマンス

#### 3.1 非同期I/O
- [ ] 同期I/Oでイベントループをブロックしていないか
- [ ] ファイルI/Oは`aiofiles`等の非同期ライブラリを使用しているか
- [ ] データベースアクセスは非同期ドライバを使用しているか

#### 3.2 レスポンス設計
- [ ] バッファに追加後、即座にレスポンスを返しているか（非同期処理）
- [ ] 低速なI/O処理を待たずにクライアントに応答しているか
- [ ] バックプレッシャー（過負荷時の制御）は考慮されているか

#### 3.3 バッファリング
- [ ] バッファのフラッシュ条件（サイズ・時間）は適切か
- [ ] メモリ使用量の上限は設定されているか
- [ ] バッファ満杯時の挙動は定義されているか

### 4. データ処理

#### 4.1 ストリーム処理
- [ ] TCPストリームの特性（データ分割・結合）は考慮されているか
- [ ] メッセージのデリミタ（改行等）は明確か
- [ ] 不完全なメッセージの処理は定義されているか

#### 4.2 パース・正規化
- [ ] 対応するデータ形式は明記されているか
- [ ] パースエラー時の処理は定義されているか
- [ ] データ検証・サニタイゼーションは実装されているか

### 5. エラーハンドリング

#### 5.1 例外処理
- [ ] 想定されるエラーケースは洗い出されているか
- [ ] エラー時のリトライ・フォールバック処理はあるか
- [ ] エラーログ・メトリクスの設計はあるか

#### 5.2 データロス防止
- [ ] シャットダウン時のバッファフラッシュは実装されているか
- [ ] ディスク容量不足時の処理は定義されているか
- [ ] トランザクション管理は必要か

### 6. セキュリティ

#### 6.1 入力検証
- [ ] 外部入力は全て検証されているか
- [ ] インジェクション攻撃への対策はあるか
- [ ] サイズ制限・レート制限は設定されているか

#### 6.2 認証・認可
- [ ] APIエンドポイントに認証は必要か
- [ ] APIキー・トークンの管理方法は定義されているか
- [ ] TLS/SSL通信は考慮されているか

### 7. 設定管理

#### 7.1 設定ファイル
- [ ] ハードコードされた値はないか
- [ ] 環境ごとの設定分離は可能か
- [ ] 機密情報（パスワード等）の管理方法は適切か

#### 7.2 デフォルト値
- [ ] デフォルト値は適切に設定されているか
- [ ] 本番環境で使用可能な設定か

### 8. テスト計画

#### 8.1 テスト範囲
- [ ] ユニットテスト・統合テストの計画はあるか
- [ ] エッジケース・異常系のテストは含まれているか
- [ ] パフォーマンステストの計画はあるか

#### 8.2 テストデータ
- [ ] テストフィクスチャの準備は計画されているか
- [ ] モック・スタブの使用箇所は明確か

### 9. 運用・監視

#### 9.1 ログ・メトリクス
- [ ] ログレベル（debug/info/warning/error）は適切か
- [ ] 監視すべきメトリクスは定義されているか
- [ ] ヘルスチェックエンドポイントはあるか

#### 9.2 デプロイ・スケーリング
- [ ] デプロイ手順は定義されているか
- [ ] スケールアウト・スケールアップの方法は明確か
- [ ] ローリングアップデート時の考慮事項はあるか

### 10. ドキュメント

#### 10.1 設計書の完成度
- [ ] システム全体像は理解できるか
- [ ] 実装に必要な情報は揃っているか
- [ ] 図表は適切に使用されているか

#### 10.2 保守性
- [ ] 将来の拡張性は考慮されているか
- [ ] 技術的負債は明記されているか
- [ ] 既知の制限事項は文書化されているか

---

## 🔍 レビュー実施方法

1. **準備**: 設計書を事前に読み込む
2. **チェック**: 上記チェックリストに沿って確認
3. **コメント**: 問題点・改善提案をフィードバック
4. **議論**: 設計者と認識合わせ
5. **承認**: 問題が解決したら承認

---

## 📝 コメント優先度

### HIGH（高優先度）
- システムの正常動作に影響する問題
- セキュリティリスク
- データロスの可能性
- パフォーマンスへの重大な影響

### MEDIUM（中優先度）
- 保守性・拡張性への影響
- ベストプラクティスからの逸脱
- 軽微なバグの可能性

### LOW（低優先度）
- コードスタイル・命名
- ドキュメントの改善提案
- より良い実装方法の提案

---

## 🎓 過去のレビューから学んだ観点

### Geminiレビューから（2026-02-17）

1. **コンテナ環境でのホスト名**
   - `localhost`は同一コンテナ内を指す
   - コンテナ間通信にはサービス名を使用する

2. **TCPストリーム処理**
   - 1回のreadで複数メッセージを受信する可能性
   - 1回のreadでメッセージ途中でデータが途切れる可能性
   - 改行をデリミタとしたメッセージフレーミングが必要

3. **非同期I/Oの重要性**
   - `async def`内で同期I/O (`open()`) を使うとイベントループがブロック
   - `aiofiles`等の非同期ライブラリを使用すべき
   - 高スループットアプリケーションでは致命的

4. **条件分岐の正確性**
   - 独立した`if`文は両方実行される可能性
   - `if-elif-else`で排他的に分岐する

5. **正規表現の厳密性**
   - 行末`$`を省略すると予期しないデータが暗黙的に切り捨てられる
   - 行全体を確実にマッチさせる

6. **バッファリングの非同期性**
   - バッファに追加後、即座に200 OKを返す
   - ストレージ書き込みは非同期で実行
   - 同期処理ではバッファリングの利点が活かせない

---

## 🔗 関連ドキュメント

- [実装チェックリスト](03-04-implementation-checklist.md)
- [コードレビュー基準](../templates/code-review-guidelines.md) ※作成予定
- [アーキテクチャ設計原則](../../01-project.d/03-architecture.md)
