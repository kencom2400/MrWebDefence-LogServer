# S3出力設定（オプション）
# MrWebDefence-LogServer
#
# 使用方法:
# 1. fluent.confに以下を追加:
#    @include conf.d/04-output-s3.conf
# 2. 環境変数を設定:
#    - AWS_ACCESS_KEY_ID
#    - AWS_SECRET_ACCESS_KEY
#    - AWS_REGION
#    - S3_BUCKET_NAME

# S3へのログ出力（オプション機能）
<label @log_storage_s3>
  <match **>
    @type s3
    @id output_s3_storage
    
    # S3設定
    s3_bucket "#{ENV['S3_BUCKET_NAME']}"
    s3_region "#{ENV['AWS_REGION']}"
    
    # S3パス: 顧客別・ログタイプ別・FQDN別・時間別
    # パターン: logs/{customer_name}/{log_type}/{fqdn}/{year}/{month}/{day}/{hour}.log.gz
    path logs/${customer_name}/${log_type}/${fqdn}/%Y/%m/%d/%H
    s3_object_key_format "%{path}_%{index}.%{file_extension}"
    
    # ファイル設定
    <format>
      @type json
    </format>
    
    # 圧縮設定
    store_as gzip
    
    # バッファ設定: 時間・顧客・ログタイプ・FQDNごとにチャンキング
    <buffer time,customer_name,log_type,fqdn>
      @type file
      path /var/log/fluentd/buffer/s3
      
      # 時間ベースのチャンキング（1時間ごと）
      timekey 1h
      timekey_wait 10m
      timekey_use_utc true
      
      # バッファサイズ制限
      chunk_limit_size 256m
      total_limit_size 2g
      
      # フラッシュ設定
      flush_mode interval
      flush_interval 5m
      flush_at_shutdown true
      flush_thread_count 4
      
      # リトライ設定
      retry_type exponential_backoff
      retry_timeout 24h
      retry_max_interval 5m
      retry_wait 1m
      
      # オーバーフロー時の動作
      overflow_action block
    </buffer>
    
    # タイムスタンプ挿入
    <inject>
      time_key timestamp
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%LZ
      timezone UTC
    </inject>
    
    # ストレージクラス（コスト最適化）
    storage_class INTELLIGENT_TIERING
  </match>
</label>
