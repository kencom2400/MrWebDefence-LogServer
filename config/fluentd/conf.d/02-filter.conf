# フィルタ設定 - ログ正規化・サニタイズ
# MrWebDefence-LogServer

# 全ログ共通の処理
<filter **>
  @type record_transformer
  @id filter_add_metadata
  enable_ruby true
  
  <record>
    # LogServer側のメタデータを追加
    received_at ${Time.now.utc.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
    logserver_hostname ${Socket.gethostname}
    
    # タイムスタンプの正規化（存在しない場合は現在時刻）
    normalized_time ${record["time"] || Time.now.utc.strftime('%Y-%m-%dT%H:%M:%S.%LZ')}
  </record>
</filter>

# Nginx/OpenAppSecログの共通処理
<filter {nginx,openappsec}.**>
  @type record_transformer
  @id filter_common_fields
  enable_ruby true
  
  <record>
    # 必須フィールドの検証（存在しない場合はプレースホルダー）
    customer_name ${record["customer_name"] || "unknown"}
    fqdn ${record["fqdn"] || "unknown"}
    
    # Path Traversal対策（危険な文字列を除去）
    safe_customer_name ${(record["customer_name"] || "unknown").gsub(/[^a-zA-Z0-9_-]/, '_')}
    safe_fqdn ${(record["fqdn"] || "unknown").gsub(/[^a-zA-Z0-9._-]/, '_')}
  </record>
</filter>

# Nginxログの固有処理
<filter nginx.**>
  @type record_transformer
  @id filter_nginx_specifics
  
  <record>
    log_type "nginx"
  </record>
</filter>

# OpenAppSecログの固有処理
<filter openappsec.**>
  @type record_transformer
  @id filter_openappsec_specifics
  
  <record>
    log_type "openappsec"
    severity ${record["severity"] || "info"}
  </record>
</filter>

# 不正なログを別ストリームにルーティング（データ損失防止）
<filter **>
  @type rewrite_tag_filter
  @id filter_rewrite_invalid_logs
  
  <rule>
    key customer_name
    pattern /^unknown$/
    tag invalid.${tag}
  </rule>
  
  <rule>
    key fqdn
    pattern /^unknown$/
    tag invalid.${tag}
  </rule>
</filter>
