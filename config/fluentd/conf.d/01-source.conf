# 入力設定 - ログ受信エンドポイント
# MrWebDefence-LogServer

# ログ受信エンドポイント（Engine Fluentdから）
<source>
  @type http
  @id input_http_logserver
  
  # バインド設定
  port 8888
  bind 0.0.0.0
  
  # TLS暗号化（mTLS）
  <transport tls>
    version TLS1_2 TLS1_3
    ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256
    
    # サーバー証明書
    cert_path /etc/fluentd/certs/logserver.crt
    private_key_path /etc/fluentd/certs/logserver.key
    
    # クライアント証明書検証（mTLS）
    client_cert_auth true
    ca_path /etc/fluentd/certs/ca.crt
  </transport>
  
  # パース設定
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S%z
    keep_time_key true
  </parse>
  
  # レート制限（DoS対策）
  add_http_headers true
  add_remote_addr true
  
  # Body size制限（10MB）
  body_size_limit 10m
  keepalive_timeout 10s
  
  # 共有シークレット認証
  <security>
    self_hostname logserver-01
    shared_key "#{ENV['FLUENTD_SHARED_KEY']}"
  </security>
</source>

# モニタリング用エンドポイント
<source>
  @type monitor_agent
  @id input_monitor_agent
  bind 0.0.0.0
  port 24220
</source>

# Prometheusメトリクス
<source>
  @type prometheus
  @id input_prometheus
  bind 0.0.0.0
  port 24231
  metrics_path /metrics
</source>

# ヘルスチェック用エンドポイント
<source>
  @type http
  @id input_http_healthcheck
  port 8889
  bind 127.0.0.1
  
  <parse>
    @type none
  </parse>
</source>
