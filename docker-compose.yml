version: '3.8'

services:
  fluentd:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mrwebdefence-logserver
    ports:
      - "8888:8888"    # Log receiver (HTTP, Engine側と同一)
      - "8889:8889"    # Health check
      - "24220:24220"  # Monitor agent
      - "24231:24231"  # Prometheus metrics
    volumes:
      # Fluentd設定ファイル
      - ./config/fluentd:/fluentd/etc:ro
      # ログストレージ
      - logs:/var/log/mrwebdefence
      # バッファ
      - buffer:/var/log/fluentd/buffer
      # 不正なログ
      - invalid:/var/log/fluentd/invalid
      # 処理できなかったログ
      - unmatched:/var/log/fluentd/unmatched
    environment:
      - FLUENTD_LOG_LEVEL=${FLUENTD_LOG_LEVEL:-info}
      - MONITORING_BIND_ADDR=${MONITORING_BIND_ADDR:-127.0.0.1}
    restart: unless-stopped
    networks:
      - logserver-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8889/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

volumes:
  logs:
    driver: local
  buffer:
    driver: local
  invalid:
    driver: local
  unmatched:
    driver: local

networks:
  logserver-network:
    driver: bridge
