# 出力設定 - ファイルストレージ
# MrWebDefence-LogServer

# ログをストレージラベルにルーティング
<match {nginx,openappsec}.**>
  @type relabel
  @label @log_storage
</match>

# 共通のファイルストレージ設定
<label @log_storage>
  <match **>
    @type file
    @id output_file_storage
    
    # 動的なファイルパス: /var/log/mrwebdefence/{customer_name}/{log_type}/{fqdn}/
    # filterで追加された safe_customer_name, log_type, safe_fqdn を使用
    # timekeyで1時間ごとにファイルが切り替わる（chunk_idにタイムスタンプが含まれる）
    path /var/log/mrwebdefence/${safe_customer_name}/${log_type}/${safe_fqdn}/access
    path_suffix ".log"
    
    # バッファ設定: タグベースのチャンキング
    <buffer safe_customer_name,log_type,safe_fqdn>
      @type file
      path /var/log/fluentd/buffer/storage
      
      # 時間ベースのチャンキング（1時間ごと）
      timekey 1h
      timekey_wait 10s
      timekey_use_utc true
      
      # バッファサイズ制限（DoS対策）
      chunk_limit_size 256m
      total_limit_size 2g
      
      # フラッシュ設定
      flush_mode interval
      flush_interval 10s
      flush_at_shutdown true
      flush_thread_count 2
      
      # リトライ設定
      retry_type exponential_backoff
      retry_timeout 1h
      retry_max_interval 30s
      retry_wait 10s
      
      # オーバーフロー時の動作
      overflow_action block
    </buffer>
    
    # ファイル出力形式（JSON Lines）
    <format>
      @type json
    </format>
    
    # ファイル圧縮
    compress gzip
    
    # タイムスタンプ挿入
    <inject>
      time_key timestamp
      time_type string
      time_format %Y-%m-%dT%H:%M:%S.%LZ
      timezone UTC
    </inject>
  </match>
</label>

# 不正なログ（customer_name/fqdn欠損）を別ファイルに出力（データ損失防止）
<match invalid.**>
  @type file
  @id output_invalid
  
  path /var/log/fluentd/invalid/invalid
  path_suffix ".log"
  
  <buffer time>
    @type file
    path /var/log/fluentd/buffer/invalid
    timekey 1h
    timekey_wait 10s
    flush_interval 10s
  </buffer>
  
  <format>
    @type json
  </format>
</match>

# 処理できなかったログを別ファイルに出力（デバッグ用）
<match **>
  @type file
  @id output_unmatched
  
  path /var/log/fluentd/unmatched/unmatched
  path_suffix ".log"
  
  <buffer time>
    @type file
    path /var/log/fluentd/buffer/unmatched
    timekey 1h
    timekey_wait 10s
    flush_interval 10s
  </buffer>
  
  <format>
    @type json
  </format>
</match>
